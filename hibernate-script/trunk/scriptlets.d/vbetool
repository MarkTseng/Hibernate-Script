# -*- sh -*-
# vim:ft=sh:ts=8:sw=4:noet
# Vbetool scriptlet required Matt J Garrett's vbetool package to be useful.
#
# This scriptlet Copyright (C) Cameron Patrick, 2005, and may be
# used under the same terms as hibernate-script itself.

AddConfigHandler VbetoolOptions
AddConfigHelp "VbetoolEnable <boolean>" "Save and restore video state using vbetool before and after suspending."

# hopefully this is a good choice and nothing else uses it :-/
VBETOOL_VT=61

# pick a file to save state into
VBETOOL_FILE="/tmp/hibernate-vbestate-$$"

VbetoolSuspend() {
    # if we're switched off, don't do nuffin
    test "$VBETOOL_ENABLED" = "1" || return 1

    # save our previous VT and switch to a new one
    if fgconsole >/dev/null 2>&1; then
        VBETOOL_ORIG_VT=$(fgconsole)
    else
        # pick a VT that be know has to exist
        VBETOOL_ORIG_VT=1
    fi
    chvt $VBETOOL_VT
    tput clear

    # avoid race condition and potential local root exploit
    rm -f $VBETOOL_FILE
    ORIG_UMASK=$(umask)
    set -C noclobber
    umask 077

    # save the vbe state
    vbetool vbestate save >$VBETOOL_FILE

    # restore shell settings
    umask ${ORIG_UMASK}
    set +C noclobber
}

VbetoolResume() {
    # if we're switched off, don't do nuffin
    test "$VBETOOL_ENABLED" = "1" || return 1

    # switch the screen back on
    vbetool vbestate restore <$VBETOOL_FILE
    rm -f $VBETOOL_FILE

    # change back to our original VT
    chvt $VBETOOL_ORIG_VT
}

VbetoolOptions() {
    case $1 in
        vbetoolenable)
            BoolIsOn "$1" "$2" && VBETOOL_ENABLED=1 || VBETOOL_ENABLED=0

            if [ -z "$VBETOOL_HOOKED" ] ; then
                AddSuspendHook 97 VbetoolSuspend
                AddResumeHook 97 VbetoolResume
                VBETOOL_HOOKED=1
            fi
            ;;
        *)
            return 1
    esac

    return 0
}

