TITLE=Software Suspend FAQ;LINUXDOC

 <META NAME="GENERATOR" CONTENT="LinuxDoc-Tools 0.9.21">
 <TITLE>Software Suspend FAQ: Using Software Suspend</TITLE>
 <LINK HREF="FAQ-6.html" REL=next>
 <LINK HREF="FAQ-4.html" REL=previous>
 <LINK HREF="FAQ.html#toc5" REL=contents>
</HEAD>
<BODY>
<A HREF="FAQ-6.html">Next</A>
<A HREF="FAQ-4.html">Previous</A>
<A HREF="FAQ.html#toc5">Contents</A>
<HR>
<H2><A NAME="s5">5.</A> <A HREF="FAQ.html#toc5">Using Software Suspend</A></H2>

<H2><A NAME="ss5.1">5.1</A> <A HREF="FAQ.html#toc5.1">Swsusp doesn't seem to do anything (or: I upgraded to the latest Software Suspend 2 and my machine no longer suspends! Instead, it shuts down all drivers, etc and then starts resuming.)</A>
</H2>

<P> Earlier versions of Software Suspend 2 used the file /proc/sys/kernel/swsusp to
activate suspension. This has been deprecated. Now to activate suspension, you
will either need to use one of the following methods:
<UL>
<LI> Get an updated suspend script (eg v0.15) - an updated one is available on the download page.</LI>
<LI> <CODE>echo anything > /proc/swsusp/activate</CODE></LI>
<LI> <CODE>echo 4 > /proc/acpi/sleep</CODE> if you have a working (and not-so-buggy) ACPI implementation</LI>
</UL>
</P>
<P>And if you are still having little or no success...
<UL>
<LI> Check you have a <CODE>resume2=swap:/dev/hdXX</CODE> option on your kernel commandline in your bootloader (eg, LILO or GRUB).</LI>
<LI> Grep through <CODE>dmesg</CODE> for 'Software Suspend' to see if it is giving any error messages on boot.</LI>
<LI> Check that in your .config you have the following lines:
<BLOCKQUOTE>
<PRE>
# CONFIG_SMP is not set
CONFIG_PM=y
CONFIG_SOFTWARE_SUSPEND2=y
CONFIG_SOFTWARE_SUSPEND_SWAPWRITER=y
...
CONFIG_PROC_FS=y
...
# CONFIG_APM_IGNORE_USER_SUSPEND is not set (if you are using APM)
</PRE>
</BLOCKQUOTE>
</LI>
<LI>Did you really patch your kernel source?<P><CODE>bzcat &lt;your patch.bz2&gt; | patch --dry-run -p1 -R |more</CODE></P>
<P> should not return any failures after patching.</P>
</LI>
<LI>Did you run <CODE>make dep</CODE> after patching?</LI>
<LI>Are you really booting your freshly-compiled kernel? Run <CODE>uname -a</CODE> and check the timestamp - it should match the time of compilation.</LI>
<LI>To be absolutely certain there's nothing stale hanging about:<P><B>SAVE</B> your .config somewhere outside the kernel tree, run <CODE>make mrproper</CODE>, copy the .config back
and then run <CODE>make oldconfig dep bzImage modules</CODE>.</P>
</LI>
</UL>
</P>


<H2><A NAME="ss5.2">5.2</A> <A HREF="FAQ.html#toc5.2">It doesn't power off, but hangs forever.</A>
</H2>

<P>If you don't have ACPI or APM enabled in your kernel, Software Suspend can't tell the
hardware to power off, but if you reach a screen reading <CODE>Ready to power
down</CODE> the suspend is complete and you can manually power off.</P>

<H2><A NAME="ss5.3">5.3</A> <A HREF="FAQ.html#toc5.3">It resumes but hangs. I can't boot any more. Or, my machine reboots forever.</A>
</H2>

<P>You have to tell kernel to ignore the resume partition using the noresume2
option. On the lilo prompt, type something like "linux noresume2".  You may find
useful to have one of your lilo choices launch your kernel with the noresume2
option.  You now have to figure out why it didn't work ;-)</P>

<H2><A NAME="ss5.4">5.4</A> <A HREF="FAQ.html#toc5.4">Suspending and resuming takes ages, what can I do?</A>
</H2>

<P>Using the suspend script, most of the delay is due to the necessity of
stopping drivers before suspending and restarting them after resume. Suspending
will never be as fast as you imagine it, at least as long as hardware drivers
will not correctly handle suspending events. </P>

<P>If the delay is in writing to disk, then you may want to play with the
<CODE>image_size_limit</CODE> option in <CODE>/proc/swsusp/</CODE>. By setting a maximum
image size, Software Suspend 2 will try and free as much memory as possible to
achieve this (or failing that, flushing to disk) which will speed up suspend
and resume on machines with slow disk IO. The only downfall is that your
machine might not be as responsive on resume until buffers and caches are
restored.</P>

<P>If you are feeling daring, you can write your own customised suspend script,
which does the minumum required for your machine. Some machines can suspend
instantly simply by <CODE>echo > /proc/swsusp/activate</CODE>. Others need a bit
more of a hand - the big offenders are generally sound cards, network cards,
PCMCIA and USB.</P>

<H2><A NAME="ss5.5">5.5</A> <A HREF="FAQ.html#toc5.5">Can I switch from Windows to Linux using Software Suspend?</A>
</H2>

<P>Yes, but the result is guaranteed only if the linux and windows partitions
are totally independant. If for instance you use a FAT partition to share data
between the two operating systems, you <B>must</B> unmount the partition
before suspending. Otherwise, modification of data under Windows may be lost
when resuming Linux. Conversely, modification of data under Linux <B>will</B>
be lost if Windows 2000's own software suspension feature is used.</P>
<P>Doug has posted the following message on the swsusp mailing list concerning unmounting of drives in XP (not verified):</P>
<P>
<BLOCKQUOTE>
<PRE>
> It is posible, there is iirc something in disk manager about this, I 
> will pay about with my win2k box and see if I can find it, but I have 
> definatly seen something about it.
>
> http://support.microsoft.com/default.aspx?scid=KB;EN-US;q314449&amp;
> might be the right sort of area
>
> -- 
>      Tim Fletcher                 


Actually that link looks dead on.  Run mountvol from the command line with
no parameters and you get a list of volume IDs (hideously long strings) and
locations where they are mounted and details on syntax for how to mount 
and unmount drives.  I've attached the screen output below.  
To automate it just go to 

http://www.budja.com/shutdown/

to get a simple little command-line program for hibernating and then write
yourself a little .bat file to put it all together.
Below is one I wrote but you'll need to run mountvol to get the right
volume ID to put in here first before using it and put the right path in
for the shutdown command.  Of course I don't know yet what exactly
"unmounting" means here. Does it really synchronize the disk or whatever
is needed? I'll let ya know how the actual results are when using this to
suspend in and out of windows and linux a few times.  Next I'll try to get
my "Easy Acess Buttons" programmed and maybe I'll even be able to
reprogram the power button.  If not it's not so bad to have to click a
link somewhere to hibernate.  Oh yeah... might as well add the A drive to
this procedure... I doubt it matters though seeing as how you can pull
idle floppy's out of windows without causing any harm anyway.
</PRE>
</BLOCKQUOTE>
</P>

<H2><A NAME="ss5.6">5.6</A> <A HREF="FAQ.html#toc5.6">Can I change removable devices while suspended?</A>
</H2>

<P>This can be done provided you stop the corresponding drivers. For this
reason, it seems better to stop USB, PCMCIA and IrDA before suspending and
start the services back on resume. Under SuSE the corresponding /etc/init.d
scripts are named pcmcia, usbmgr and irda. Good precaution is also to unmount
the floppy drive.</P>

<H2><A NAME="ss5.7">5.7</A> <A HREF="FAQ.html#toc5.7">Suspension seems to occur correctly, but when I resume the suspend signature is not found.</A>
</H2>

<P>Double check that you have correctly set a resume2=swap:/dev/hdX option and that
you have updated your lilo or grub configuration. Also check that you don't
have an unwanted noresume2 option. If all this is OK than perhaps you have one
of those disks with hardware cache. Try to use hdparm -W 0 /dev/hdX before
suspending. This should disable hardware cache. Please report if you encounter
this bug since it is supposed to be fixed since 2.4.18-beta8. </P>

<H2><A NAME="ss5.8">5.8</A> <A HREF="FAQ.html#toc5.8">After resume, why is my clock at the time of suspension?</A>
</H2>

<P>The system time is stored in a part of memory that is saved during
suspension. One needs to reset the clock using hwclock upon resume, since
reading the CMOS is the only way for the system to know the real time. Use
the suspend.sh script in order to do that automatically.</P>

<H2><A NAME="ss5.9">5.9</A> <A HREF="FAQ.html#toc5.9">How can I patch Software Suspend to have a script launched on resume?</A>
</H2>

<P>You don't need that: this feature is natural with Software Suspend. See the
hibernate script for instance. </P>

<H2><A NAME="ss5.10">5.10</A> <A HREF="FAQ.html#toc5.10">Suspension seems to occur correctly, but when I resume mouse and keyboard are frozen.</A>
</H2>

<P>This seems to happen for some hardware configurations. We haven't found a
proper way to fix that for the moment. Sometimes, it seems that stopping gpm
before suspending and restarting it upon resume can help. In other cases, just
stopping gpm and never restarting it is even better. </P>

<H2><A NAME="ss5.11">5.11</A> <A HREF="FAQ.html#toc5.11">It fails to suspend with a message "not enough pages"</A>
</H2>

<P>The amount of memory needed depends on a lot of things. For the average user,
sizeof(RAM)x2 is ample for the swap partition used by Software Suspend 2. </P>

<H2><A NAME="bootsplash"></A> <A NAME="ss5.12">5.12</A> <A HREF="FAQ.html#toc5.12">How can I get Bootsplash to play with Software suspend nicely?</A>
</H2>

<P>Documentation contributed by Alessandro Barbosa (barbosa_alessandro at hotmail dot com): 
<A HREF="contrib/Swsusp2_and_Bootsplash_on_FC2.doc">Bootsplash and Software Suspend on Fedora Core 2</A></P>
<P>Or the following, thanks to Markus Gaugusch and Nigel Cunningham:</P>
<P>Bootsplash with software suspend still seems somewhat voodoo-ish, but
hopefully the steps listed here will point you in the right direction.</P>
<P>
<OL>
<LI> Patch your kernel with the official bootsplash patch from
www.bootsplash.org and read the documentation with it. Configure your kernel
with bootsplash /proc support.</LI>
<LI> Install the splash utilities from bootsplash.org and a theme.</LI>
<LI> If you are using a version 1 or 2 bootsplash image, you will need to
patch software suspend with the bootsplash-option patch in the Software Suspend 2 package
and recompile. With a version 3 bootsplash image, this is not neccesary.</LI>
<LI> On suspend, execute:
<P><CODE>/path/to/splash -s -u 62 /etc/bootsplash/themes/.../config/bootsplash-1024x768.cfg</CODE></P>
<P>If you have a version 1 or 2 image, <CODE>echo 424 582 506 30 15 > /proc/sys/kernel/splash_progress</CODE>. These numbers are x-coordinate, y-coordinate, width, height and RGB colour (24-bit).</P>
<P>This puts the splash screen on VT 63 (counting from 0), puts a black progress box roughly down the bottom.</P>
</LI>
<LI> Suspend.</LI>
<LI> On resume, execute <CODE>splash -s -u 62</CODE> to clear the bootsplash again.</LI>
<LI> Possibly change VTs back to your original one.</LI>
</OL>
</P>

<H2><A NAME="ss5.13">5.13</A> <A HREF="FAQ.html#toc5.13">Resuming complains about a version mismatch.</A>
</H2>

<P>The noresume2 kernel command line option discards the suspend image and
restores the swap signature. When using the noresume2 option, the suspended
kernel state and filesystem state is lost. When using a journaling filesystem,
no filesystem data is lost.</P>

<H3>WARNING! Scenarios that can lead to data loss or corruption:</H3>

<P>This may occur after suspending with a Software Suspend-enabled kernel, then
booting a different kernel.</P>

<H3>Scenario 1 - a second kernel recognises the suspend image</H3>

<P>The version mismatch is caused by attempting to resume a kernel whose header
does not match the header of the suspended kernel in the suspend image.</P>
<P>For example, you suspended a kernel, and recompiled it, or you suspended one
kernel and attempted to resume another one which recognizes the suspend image.
In this case, put noresume2 on the command line for this boot.</P>
<P>Should you forget, you will get a version mismatch message: <CODE>SHIFT to
reboot, CONTROL to continue</CODE> - push shift and either select the correct
kernel or use the noresume2 option to boot.</P>
<P><EM>Any</EM> difference between resumed and suspended kernels will
corrupt/crash the system on forcing resume with CONTROL and possible cause
filesystem damage as well.</P>

<H3>Scenario 2 - a second kernel does not recognise the suspend image</H3>

<P>This is more dangerous as there is no warning. For example, you have two
kernels, Kernel A and Kernel B. Kernel A has software suspend support, and
Kernel B does not.</P>
<P>The danger comes when suspending with Kernel A, you then decide to boot
Kernel B, that does not recognize the swap image. It ignores the "bad" swap
partition and runs without it as if nothing happened (except maybe if it runs
low on memory).</P>
<P>The problem to the suspended Kernel A is that since Kernel B mounted the
filesystem r/w, it no longer matches the suspended kernel and will be corrupted
on resume. Thus, severe damage to the filesystem will result once the disk is
written to by the resumed kernel. </P>
<P>Should this scenario occur, the suspended kernel must be prevented from
resuming. This can be accomplished by an mkswap of the swap partition from
Kernel B, or booting Kernel A with noresume2. </P>

<H2><A NAME="ss5.14">5.14</A> <A HREF="FAQ.html#toc5.14">Is there any way to convince Software Suspend 2 to free things like disk caches and</A>
buffers but nothing else?</H2>

<P>In short, no. If you use the <CODE>image_size_limit</CODE> option, Software Suspend 2 will
attempt to free memory until that constraint is met. Since disk caches are the
easiest thing to free, the Linux VM will free it first. If you leave the value
of <CODE>image_size_limit</CODE> at zero, it will only free as much memory as it
needs to be able to fit the image into swap.</P>

<H2><A NAME="ss5.15">5.15</A> <A HREF="FAQ.html#toc5.15">Freezer debugging: It hangs at 'Waiting for activity to finish' or 'Syncing remaining I/O'.</A>
</H2>

<P>
<OL>
<LI>Compile in debugging support if you haven't already. You may also want to increase the size of the message buffer:
<UL>
<LI>For 2.4, edit <CODE>kernel/printk.c</CODE>. Change 16384 on line 41 to a higher power of two, say 1048576</LI>
<LI>For 2.6, change the kernel log buffer size while choosing your compile options. It's under General Setup.</LI>
</UL>
</LI>
<LI>Set your debugging options as follows:
<UL>
<LI><CODE>echo 1 > /proc/swsusp/enable_escape</CODE> - ensures you can press escape to cancel the suspend when it hangs</LI>
<LI><CODE>echo 1 > /proc/swsusp/log_everything</CODE> - tells Software Suspend 2 to record all it's about to display</LI>
<LI><CODE>echo 4 > /proc/swsusp/default_console_level</CODE> - tell it to display medium level debugging</LI>
<LI><CODE>echo 2 > /proc/swsusp/debug_sections</CODE> - tell it to display messages about the freezer</LI>
</UL>
</LI>
<LI>Tell it to try to suspend: <CODE>echo > /proc/swsusp/activate</CODE></LI>
<LI>When it hangs (assuming it does), press escape. It should print a lot of information and then
return you to the command prompt.</LI>
<LI>Look in /var/log/messages. If the output does not contain the names of procedures, but instead lots 
of hexadecimal numbers, run the output through ksymoops. (See Documentation/oops-tracing in the kernel tree
for more help here).</LI>
<LI>Send your output directly to Nigel, who will usually get back to you pretty quickly. Don't send all of the
output to the list, please.</LI>
</OL>
</P>

<H2><A NAME="ss5.16">5.16</A> <A HREF="FAQ.html#toc5.16">I've suspended and resumed and now I can't open new X applications and my /tmp directory is empty (on Debian)</A>
</H2>

<P>A recent version of the initscripts package decided to blow away temporary
directories when calling <CODE>mountnfs.sh</CODE> (See 
<A HREF="http://bugs.debian.org/227112">Bug #227112</A>).  The simple
solution is to remove mountnfs.sh from your SWSUSP_STOP_SERVICES_BEFORE_SUSPEND
in /etc/suspend.conf and add your extra NFS mounts into SWSUSP_UMOUNTS.</P>

<H2><A NAME="ss5.17">5.17</A> <A HREF="FAQ.html#toc5.17">System hangs on booting a swsusp kernel (2.6)</A>
</H2>

<P>If CONFIG_CC_OPTIMIZE_FOR_SIZE is enabled, you may get a hang on boot just after:
<BLOCKQUOTE>
<PRE>
Software Suspend 2.0.0.10: Swap space signature found.
Software Suspend 2.0.0.10: Checking for image...
Software Suspend 2.0.0.10: This is normal swap space.
Software Suspend 2.0.0.10: kswsuspd starting
</PRE>
</BLOCKQUOTE>

Disabling CONFIG_CC_OPTIMIZE_FOR_SIZE appears to resolve the issue. Thanks to
Michael Schneider for recognising this problem and solution!</P>

<HR>
<A HREF="FAQ-6.html">Next</A>
<A HREF="FAQ-4.html">Previous</A>
<A HREF="FAQ.html#toc5">Contents</A>
